<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN"><HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">
<META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter">
<LINK REL="STYLESHEET" HREF="final.css" CHARSET="ISO-8859-1" TYPE="text/css">
<TITLE> NUMERICAL METHOD FOR SPECIATION AND FORWARD MODELING</TITLE>
</HEAD>
<BODY BGCOLOR="#ffffff">
<DIV>
<HR><P> | <A HREF="final-13.html">Next</A>|| <A HREF="final-11.html">Previous</A> || <A HREF="final.html">Top</A>  | </P>

</DIV>
<H1 CLASS="FM1stOrderHeading">
<A NAME="pgfId-251392"></A><STRONG CLASS="Bold">
NUMERICAL METHOD FOR SPECIATION AND FORWARD MODELING</STRONG></H1>
<P CLASS="BodyText">
<A NAME="pgfId-251393"></A>The formulation of any chemical equilibrium problem solved by PHREEQC is derived from the set of functions denoted <IMG SRC="final-279.jpg" ALIGN="MIDDLE">
 in the previous sections. These include <IMG SRC="final-280.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-281.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-282.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-283.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-284.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-285.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-286.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-287.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-288.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-289.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-290.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-291.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-292.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-293.jpg" ALIGN="MIDDLE">
, and <IMG SRC="final-294.jpg" ALIGN="MIDDLE">
, where <IMG SRC="final-295.jpg" ALIGN="MIDDLE">
 and <IMG SRC="final-296.jpg" ALIGN="MIDDLE">
 are the simply the mole-balance functions for hydrogen and oxygen and <IMG SRC="final-297.jpg" ALIGN="MIDDLE">
 refers to all aqueous master species except H<SUP CLASS="Superscript">
+</SUP>
, e<SUP CLASS="Superscript">
-</SUP>
, H<SUB CLASS="Subscript">
2</SUB>
O and the alkalinity master species. The corresponding set of master unknowns is <IMG SRC="final-298.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-299.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-300.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-301.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-302.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-303.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-304.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-305.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-306.jpg" ALIGN="MIDDLE">
 (or possibly <IMG SRC="final-307.jpg" ALIGN="MIDDLE">
 in speciation calculations), <IMG SRC="final-308.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-309.jpg" ALIGN="MIDDLE">
, <IMG SRC="final-310.jpg" ALIGN="MIDDLE">
 (or possibly <IMG SRC="final-311.jpg" ALIGN="MIDDLE">
 in speciation calculations), <IMG SRC="final-312.jpg" ALIGN="MIDDLE">
 (explicit diffuse-layer calculation), <IMG SRC="final-313.jpg" ALIGN="MIDDLE">
, and <IMG SRC="final-314.jpg" ALIGN="MIDDLE">
 (implicit diffuse-layer calculation). When the residuals of all the functions that are included for a given calculation are equal to zero, a solution to the set of nonlinear equations has been found, and the equilibrium values for the chemical system have been determined. (Note that some equations that are initially included in a given calculation may be dropped if a pure phase or gas phase does not exist at equilibrium.) The solution technique assigns initial values to the master unknowns and then uses a modification of the Newton-Raphson method iteratively to revise the values of the master unknowns until a solution to the equations has been found within specified tolerances. </P>
<P CLASS="BodyText">
<A NAME="pgfId-251508"></A>For a set of equations, <IMG SRC="final-315.jpg" ALIGN="MIDDLE">
, in unknowns <IMG SRC="final-316.jpg" ALIGN="MIDDLE">
 the Newton-Raphson method involves iteratively revising an initial set of values for the unknowns. Let <IMG SRC="final-317.jpg" ALIGN="MIDDLE">
 be the residuals of the equations for the current values of the unknowns. The following set of equations is formulated:</P>
<P CLASS="EquationNumbered">
<A NAME="pgfId-309994"></A><IMG SRC="final-318.jpg" ALIGN="MIDDLE">
,	(83)</P>
<P CLASS="BodyTextFlush">
<A NAME="pgfId-251519"></A>where <EM CLASS="Emphasis">
J</EM>
 is the total number of master unknowns for the calculation. The set of equations is linear and can be solved simultaneously for the unknowns, <IMG SRC="final-319.jpg" ALIGN="MIDDLE">
. New values of the unknowns are calculated, <IMG SRC="final-320.jpg" ALIGN="MIDDLE">
, where <EM CLASS="Emphasis">
k</EM>
 refers to the iteration number, after which, new values of the residuals are calculated. The process is repeated until the values of the residuals are less than a specified tolerance.</P>
<P CLASS="BodyText">
<A NAME="pgfId-251523"></A>Two problems arise when using the Newton-Raphson method for chemical equilibria. The first is that the initial values of the unknowns must be sufficiently close to the equilibrium values, or the method does not converge, and the second is that a singular matrix may arise if the chemical reactions for a set of phases are not linearly independent. PHREEQC uses an optimization technique developed by Barrodale and Roberts (1980) to avoid the occurrence of singular matrices. The optimization technique also allows inequality constraints to be added to the problem, which are useful for constraining the total amounts of phases and solid solutions that can react.</P>
<P CLASS="BodyText">
<A NAME="pgfId-251524"></A>The selection of initial estimates for the master unknowns is described for each type of modeling in the following sections. Regardless of the strategy for assigning the initial estimates, the estimates for the activities of the master species for elements or element valence states are revised, if necessary, before the Newton-Raphson iterations to produce approximate mole balance. The procedure for aqueous master species is as follows. After the initial estimates have been made, the distribution of species is calculated for each element (except hydrogen and oxygen) and, in initial solution calculations only, for the individual valence states which were defined. Subsequently, the ratio of the calculated moles to the input moles is calculated. If the ratio for a master species <IMG SRC="final-321.jpg" ALIGN="MIDDLE">
 is greater than 1.5 or less than 10<SUP CLASS="Superscript">
-5</SUP>
, the following equation is used to revise the value of the master unknown:</P>
<P CLASS="EquationNumbered">
<A NAME="pgfId-310020"></A><A NAME="11382"></A><IMG SRC="final-322.jpg" ALIGN="MIDDLE">
,	(84)</P>
<P CLASS="BodyTextFlush">
<A NAME="pgfId-251535"></A>where <IMG SRC="final-323.jpg" ALIGN="MIDDLE">
 is 1.0 if the ratio is greater than 1.5 and 0.3 if the ratio is less than 10<SUP CLASS="Superscript">
-5</SUP>
, and <IMG SRC="final-324.jpg" ALIGN="MIDDLE">
 is the total concentration of an element or element valence state. Analogous equations are used for exchange and surface master species. After revisions to the initial estimates, the distribution of species is calculated. The iterations continue until the ratios are within the specified ranges, at which point the modified Newton-Raphson technique is used. If the successive revisions fail to find activities such that the ratios are within the specified bounds, then a second set of iterations tries to reduce the ratios below 1.5 with no lower limit to these ratios. Whether or not the second set of iterations succeeds, the Newton-Raphson technique is then used. </P>
<P CLASS="BodyText">
<A NAME="pgfId-251536"></A>The optimization technique of Barrodale and Roberts (1980) is a modification of the simplex linear programming algorithm that minimizes the sum of absolute values of residuals (L1 optimization) on a set of linear equations subject to equality and inequality constraints. The general problem can be posed with the following matrix equations:</P>
<P CLASS="EquationNumbered">
<A NAME="pgfId-251540"></A><IMG SRC="final-325.jpg" ALIGN="MIDDLE">
.	(85)</P>
<P CLASS="BodyTextFlush">
<A NAME="pgfId-251544"></A>The first matrix equation is minimized in the sense that <IMG SRC="final-326.jpg" ALIGN="MIDDLE">
 is a minimum, where <IMG SRC="final-327.jpg" ALIGN="MIDDLE">
 is the number</P>
<P CLASS="BodyTextFlush">
<A NAME="pgfId-389802"></A>of equations to be optimized, subject to the equality constraints of the second matrix equation and the inequality constraints of the third matrix equation.</P>
<P CLASS="BodyText">
<A NAME="pgfId-251545"></A>The approach of PHREEQC is to include some of the Newton-Raphson equations in the optimization equations (<IMG SRC="final-328.jpg" ALIGN="MIDDLE">
), rather than include all of the Newton-Raphson equations as equalities (<IMG SRC="final-329.jpg" ALIGN="MIDDLE">
). Equations that are included in the <EM CLASS="Emphasis">
A</EM>
 matrix may not be solved for exact equality at a given iteration, but will be optimized in the sense given above. Thus, at a given iteration, an approximate mathematical solution to the set of Newton-Raphson equations can be found even if no exact equality solution exists, for example when forcing equality for all equations would result in an unsolvable singular matrix. The equations for alkalinity, total moles of gas in the gas phase, pure phases, and solid-solution components are included in the <EM CLASS="Emphasis">
A</EM>
 matrix. All mole-balance, charge-balance, and surface-potential equations are included in the <EM CLASS="Emphasis">
B</EM>
 matrix. Inequalities that limit the dissolution of pure phases, solid-solution components, and gas components to the amounts present in the system are included in the <EM CLASS="Emphasis">
C</EM>
 matrix.</P>
<P CLASS="BodyText">
<A NAME="pgfId-321030"></A>In an attempt to avoid some numerical problems related to small numbers in the <EM CLASS="Emphasis">
B</EM>
 matrix, a row of the matrix that represents a mole-balance equation is scaled if all coefficients (a column of <EM CLASS="Emphasis">
A</EM>
 and <EM CLASS="Emphasis">
B</EM>
) of the corresponding unknown (change in the log activity of the element master species) are less than 1e-10. In this case, the equation is scaled by 1e-10 divided by the absolute value of the largest coefficient. Alternatively, when specified, (<STRONG CLASS="Bold">
-diagonal_scale</STRONG> in <STRONG CLASS="Bold">
<A HREF="final-46.html#95186" CLASS="XRef">KNOBS</A></STRONG>), a mole-balance equation is scaled by 1e-10 divided by the coefficient of the corresponding unknown if the coefficient of the unknown in the mole-balance equation is less than 1e-10. </P>
<P CLASS="BodyText">
<A NAME="pgfId-251552"></A>The scaled matrix is solved by the optimizing solver, and the solution that is returned is a vector of changes to the values of the master unknowns. The values of the changes are checked to ensure that the changes to the unknowns are less than criteria that limit the maximum allowable size of changes. These criteria are specified by default in the program or by input in the <STRONG CLASS="Bold">
<A HREF="final-46.html#95186" CLASS="XRef">KNOBS</A></STRONG> data block. If any of the changes are too large, then all the changes to the unknowns, except the mole transfers of pure phases and solid-solution components, are decreased proportionately to satisfy all of the criteria. Pure-phase and solid-solution mole transfers are not altered except to produce nonnegative values for the total moles of the pure phases and solid-solution components. After suitable changes to the unknowns have been calculated, the master unknowns are updated; new molalities and activities of all the aqueous, exchange, and surface species are calculated, and residuals for all of the functions are calculated. The residuals are tested for convergence (convergence criteria are defined internally in the program, but can be switched to an alternate set with the <STRONG CLASS="Bold">
-convergence_tolerance</STRONG> in <STRONG CLASS="Bold">
<A HREF="final-46.html#95186" CLASS="XRef">KNOBS</A></STRONG> or <STRONG CLASS="Bold">
-high_precision</STRONG> option in <STRONG CLASS="Bold">
<A HREF="final-54.html#20239" CLASS="XRef">SELECTED_OUTPUT</A></STRONG> data blocks), and a new iteration is begun if convergence has not been attained.</P>
<HR><P> | <A HREF="final-13.html">Next</A>|| <A HREF="final-11.html">Previous</A> || <A HREF="final.html">Top</A>  | </P>

</BODY>
</HTML>

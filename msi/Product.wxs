<?xml version="1.0" encoding="UTF-8"?>

<?include Version.wxi?>
<!--
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
-->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

    <!-- product -->
	<Product Id="*"
           Name="$(var.FullName)"
           Language="1033"
           Version="$(var.Version)"
           Manufacturer="$(var.Manufacturer)"
           UpgradeCode="$(var.UpgradeGuid)">
   
    <!-- package -->
    <Package InstallerVersion="300"
             Compressed="yes" />

		<Media Id="1" Cabinet="$(var.Cabinet)" EmbedCab="yes" />

    <!-- directory structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <!-- program files -->
      <Directory Id="ProgramFilesFolder">
        <Directory Id="USGS" Name="USGS">
          <Directory Id="APPLICATIONFOLDER" Name="$(var.FullName)">
            <Directory Id="bin" Name="bin">
            </Directory>
            <Directory Id="doc" Name="doc">
            </Directory>
            <Directory Id="examples" Name="examples">
            </Directory>
          </Directory>
        </Directory>
			</Directory>
      <!-- start menu -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="$(var.FullName)"/>
      </Directory>
    </Directory>

    <!-- phreeqci.exe -->
    <DirectoryRef Id="bin">
      <Component Id="phreeqci.exe" Guid="B8AF93AA-3BF9-4913-8CD7-3209AF74ECF2">
        <File Id="phreeqci.exe" Name="phreeqci.exe" Source="..\Release\phreeqci.exe" />
        <!-- Phreeqci.Input -->
        <ProgId Id="Phreeqci.Input" Description="Phreeqci Input File" Icon="phreeqci.exe" IconIndex="1">
          <Extension Id="pqi">
            <Verb Id="open" TargetFile="phreeqci.exe" Argument="/dde"/>
            <Verb Id="print" TargetFile="phreeqci.exe" Argument="/dde"/>
            <Verb Id="printto" TargetFile="phreeqci.exe" Argument="/dde"/>
          </Extension>
        </ProgId>
        <RegistryValue Root="HKCR" Key=".pqi\ShellNew" Name="NullFile" Value="" Type="string" Action="write" />
        <RegistryValue Root="HKCR" Key="Phreeqci.Input\shell\open\ddeexec" Value="[\[]open(&quot;%1&quot;)[\]]" Type="string" Action="write" />
        <RegistryValue Root="HKCR" Key="Phreeqci.Input\shell\print\ddeexec" Value="[\[]print(&quot;%1&quot;)[\]]" Type="string" Action="write" />
        <RegistryValue Root="HKCR" Key="Phreeqci.Input\shell\printto\ddeexec" Value="[\[]printto(&quot;%1&quot;,&quot;%2&quot;,&quot;%3&quot;,&quot;%4&quot;)[\]]" Type="string" Action="write" />
        <!-- Phreeqci.Output -->
        <ProgId Id="Phreeqci.Output" Description="Phreeqci Output File" Icon="phreeqci.exe" IconIndex="2">
          <Extension Id="pqo">
            <Verb Id="open" TargetFile="phreeqci.exe" Argument="/dde"/>
            <Verb Id="print" TargetFile="phreeqci.exe" Argument="/dde"/>
            <Verb Id="printto" TargetFile="phreeqci.exe" Argument="/dde"/>
          </Extension>
        </ProgId>
        <RegistryValue Root="HKCR" Key="Phreeqci.Output\shell\open\ddeexec" Value="[\[]open(&quot;%1&quot;)[\]]" Type="string" Action="write" />
        <RegistryValue Root="HKCR" Key="Phreeqci.Output\shell\print\ddeexec" Value="[\[]print(&quot;%1&quot;)[\]]" Type="string" Action="write" />
        <RegistryValue Root="HKCR" Key="Phreeqci.Output\shell\printto\ddeexec" Value="[\[]printto(&quot;%1&quot;,&quot;%2&quot;,&quot;%3&quot;,&quot;%4&quot;)[\]]" Type="string" Action="write" />
        <File Id="phreeqci.chm" Name="phreeqci.chm" Source="..\Help\phreeqci.chm" />
        <File Id="fs03102.chm" Name="fs-031-02.chm" Source="..\fs-031-02\fs-031-02.chm" />
        <File Id="phreeqci.eng" Name="phreeqci.eng" Source="..\phreeqci.eng" />
        <File Id="phreeqc.dat" Name="phreeqc.dat" Source="..\phreeqc\database\phreeqc.dat" />
      </Component>
    </DirectoryRef>

    <!-- phreeqci.exe.lnk -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="137CAEA5-1C21-4888-A8F2-1AD3CF17DA49">
        <Shortcut Id="ApplicationStartMenuShortcut"
                  Name="$(var.FullName)"
                  Target="[bin]phreeqci.exe"
                  WorkingDirectory="bin"/>
        <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall"/>
        <RegistryValue Root="HKCU" Key="Software\USGS\Phreeqci" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- SRCDBPG.ocx -->
    <DirectoryRef Id="bin">
      <Component Id="SRCDBPG.ocx" Guid="A7B93CEA-BA9D-4ade-9B4D-7B29D82BFD51">
        <File Id="SRCDBPG.ocx" KeyPath="yes" Source="..\SRCDBPG\Release\SRCDBPG.ocx">
          <Class Id="{D48E3786-6364-4F71-9C7B-094DB9CC733A}" Context="InprocServer32" Description="SRCDBPager Property Page" />
          <TypeLib Id="{E17E5A9E-F5E4-4CD4-98BC-E068D20CFA40}" Control="yes" Description="SRCDBPG ActiveX Control module" HelpDirectory="bin" Language="0" MajorVersion="1" MinorVersion="0">
            <Class Id="{5EE2FCD7-F527-4900-AF7C-33BCC60627FB}" Context="InprocServer32" Description="SRCDBPager Control" ThreadingModel="apartment" Version="1.0" Control="yes">
              <ProgId Id="SRCDBPG.SRCDBPGCtrl.1" Description="SRCDBPager Control" />
            </Class>
            <Interface Id="{2540D29A-5FB9-494D-A2A1-7AD80599E582}" Name="_DSRCDBPG" ProxyStubClassId="{00020420-0000-0000-C000-000000000046}" ProxyStubClassId32="{00020420-0000-0000-C000-000000000046}" />
            <Interface Id="{2B08B6FA-7B7E-43F4-A17B-BA20046993C0}" Name="_DSRCDBPGEvents" ProxyStubClassId="{00020420-0000-0000-C000-000000000046}" ProxyStubClassId32="{00020420-0000-0000-C000-000000000046}" />
          </TypeLib>
        </File>
        <RegistryValue Root="HKCR" Key="CLSID\{5EE2FCD7-F527-4900-AF7C-33BCC60627FB}\MiscStatus\1" Value="131473" Type="string" Action="write" />
        <RegistryValue Root="HKCR" Key="CLSID\{5EE2FCD7-F527-4900-AF7C-33BCC60627FB}\MiscStatus" Value="0" Type="string" Action="write" />
        <RegistryValue Root="HKCR" Key="CLSID\{5EE2FCD7-F527-4900-AF7C-33BCC60627FB}\ToolboxBitmap32" Value="[!SRCDBPG.ocx], 1" Type="string" Action="write" />
      </Component>
    </DirectoryRef>

    <!-- examples -->
    <DirectoryRef Id="examples">
      <Component Id="examples" Guid="C5488E67-CABC-4380-B51F-4ACB02F74FC2">
        <File Id="ex1.pqi" Name="ex1.pqi" Source="..\phreeqc\examples\ex1" />
        <File Id="ex2.pqi" Name="ex2.pqi" Source="..\phreeqc\examples\ex2" />
        <File Id="ex3.pqi" Name="ex3.pqi" Source="..\phreeqc\examples\ex3" />
        <File Id="ex4.pqi" Name="ex4.pqi" Source="..\phreeqc\examples\ex4" />
        <File Id="ex5.pqi" Name="ex5.pqi" Source="..\phreeqc\examples\ex5" />
        <File Id="ex6.pqi" Name="ex6.pqi" Source="..\phreeqc\examples\ex6" />
        <File Id="ex7.pqi" Name="ex7.pqi" Source="..\phreeqc\examples\ex7" />
        <File Id="ex8.pqi" Name="ex8.pqi" Source="..\phreeqc\examples\ex8" />
        <File Id="ex9.pqi" Name="ex9.pqi" Source="..\phreeqc\examples\ex9" />
        <File Id="ex10.pqi" Name="ex10.pqi" Source="..\phreeqc\examples\ex10" />
        <File Id="ex11.pqi" Name="ex11.pqi" Source="..\phreeqc\examples\ex11" />
        <File Id="ex12.pqi" Name="ex12.pqi" Source="..\phreeqc\examples\ex12" />
        <File Id="ex12a.pqi" Name="ex12a.pqi" Source="..\phreeqc\examples\ex12a" />
        <File Id="ex13a.pqi" Name="ex13a.pqi" Source="..\phreeqc\examples\ex13a" />
        <File Id="ex13b.pqi" Name="ex13b.pqi" Source="..\phreeqc\examples\ex13b" />
        <File Id="ex13c.pqi" Name="ex13c.pqi" Source="..\phreeqc\examples\ex13c" />
        <File Id="ex14.pqi" Name="ex14.pqi" Source="..\phreeqc\examples\ex14" />
        <File Id="ex15.pqi" Name="ex15.pqi" Source="..\phreeqc\examples\ex15" />
        <File Id="ex15.dat" Name="ex15.dat" Source="..\phreeqc\examples\ex15.dat" />
        <File Id="ex16.pqi" Name="ex16.pqi" Source="..\phreeqc\examples\ex16" />
        <File Id="ex17.pqi" Name="ex17.pqi" Source="..\phreeqc\examples\ex17" />
        <File Id="ex18.pqi" Name="ex18.pqi" Source="..\phreeqc\examples\ex18" />

        <!-- TEMP -->
        <!--
        <IniFile Id="ex1.ini" Name="ex1.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]bin\phreeqc.dat"/>
        <IniFile Id="ex2.ini" Name="ex2.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]bin\phreeqc.dat"/>
        <IniFile Id="ex3.ini" Name="ex3.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]bin\phreeqc.dat"/>
        <IniFile Id="ex4.ini" Name="ex4.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]bin\phreeqc.dat"/>
        <IniFile Id="ex5.ini" Name="ex5.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]bin\phreeqc.dat"/>
        <IniFile Id="ex6.ini" Name="ex6.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]bin\phreeqc.dat"/>
        <IniFile Id="ex7.ini" Name="ex7.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]bin\phreeqc.dat"/>
        <IniFile Id="ex8.ini" Name="ex8.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]bin\phreeqc.dat"/>
        <IniFile Id="ex9.ini" Name="ex9.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]bin\phreeqc.dat"/>
        <IniFile Id="ex10.ini" Name="ex10.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]bin\phreeqc.dat"/>
        <IniFile Id="ex11.ini" Name="ex11.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]bin\phreeqc.dat"/>
        <IniFile Id="ex12.ini" Name="ex12.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]bin\phreeqc.dat"/>
        <IniFile Id="ex12a.ini" Name="ex12a.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]bin\phreeqc.dat"/>
        <IniFile Id="ex13a.ini" Name="ex13a.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]bin\phreeqc.dat"/>
        <IniFile Id="ex13b.ini" Name="ex13b.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]bin\phreeqc.dat"/>
        <IniFile Id="ex13c.ini" Name="ex13c.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]bin\phreeqc.dat"/>
        <IniFile Id="ex14.ini" Name="ex14.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]bin\wateq4f.dat"/>
        <IniFile Id="ex15.ini" Name="ex15.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]examples\ex15.dat"/>
        <IniFile Id="ex16.ini" Name="ex16.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]bin\phreeqc.dat"/>
        <IniFile Id="ex17.ini" Name="ex17.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]bin\phreeqc.dat"/>
        <IniFile Id="ex18.ini" Name="ex18.ini" Action="addLine" Section="Database" Directory="examples" Key="Database" Value="[APPLICATIONFOLDER]bin\phreeqc.dat"/>
        -->

        <File Id="ex14.xml" Name="ex14.xml" Source="..\phreeqc\examples\ex15.xml"/>
        <File Id="ex15.xml" Name="ex15.xml" Source="..\phreeqc\examples\ex15.xml"/>
        <!--
        <util:XmlFile Id="ex15.xml" File="[APPLICATIONFOLDER]examples\ex15.xml" Action="createElement" Name="Database" ElementPath="//Phreeqc" Value="[APPLICATIONFOLDER]examples\ex15.dat"/>
        -->

        <!-- TEMP -->
      </Component>
    </DirectoryRef>

    <!-- merge modules -->
    <DirectoryRef Id="APPLICATIONFOLDER">
      <!-- CRT/MFC -->
      <Merge Id="CRT" Language="1033" SourceFile="$(var.MergeDir)\microsoft_vc80_crt_x86.msm" DiskId="1" />
      <Merge Id="CRT Policy" Language="1033" SourceFile="$(var.MergeDir)\policy_8_0_Microsoft_VC80_CRT_x86.msm" DiskId="1" />
      <Merge Id='MFC' Language='0' SourceFile='$(var.MergeDir)\Microsoft_VC80_MFC_x86.msm' DiskId='1' />
      <Merge Id='MFC Policy' Language='0' SourceFile='$(var.MergeDir)\policy_8_0_Microsoft_VC80_MFC_x86.msm' DiskId='1' />
      <!-- mshflxgd.ocx -->
      <Merge Id="MSHFLXGD" Language="1033" SourceFile="msm\mshflxgd.msm" DiskId="1" />
      <Merge Id="COMCAT" Language="1033" SourceFile="msm\comcat.msm" DiskId="1" />
      <Merge Id="OLEAUT32" Language="1033" SourceFile="msm\oleaut32.msm" DiskId="1" />
    </DirectoryRef>

    <!-- reqd to merge MSHFLXGD/COMCAT/OLEAUT32
    ie error LGHT0204: ICE03: Table: Class Column: CLSID Missing specifications
    in _Validation Table (or Old Database)
    -->
    <EnsureTable Id="Class" />
    <EnsureTable Id="Extension" />
    <EnsureTable Id="MIME" />

    <Feature Id="ProductFeature" Title="msi" Level="1">
      <ComponentRef Id="phreeqci.exe" />
      <ComponentRef Id="ApplicationShortcut" />
      <ComponentRef Id="SRCDBPG.ocx" />
      <ComponentRef Id="examples" />      
      <MergeRef Id='CRT' />
      <MergeRef Id='CRT Policy' />
      <MergeRef Id='MFC'/>
      <MergeRef Id='MFC Policy' />
      <MergeRef Id='MSHFLXGD' />
      <MergeRef Id='COMCAT' />
      <MergeRef Id='OLEAUT32' />
    </Feature>

    <!-- gui -->
    <!-- UIRef Id="WixUI_Minimal"/ -->
    <UIRef Id="WixUI_Advanced"/>    
    <Property Id="ApplicationFolderName" Value="$(var.FullName)" />
    <Property Id="WixAppFolder" Value="WixPerMachineFolder" />
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

    <!--
    <CustomTable Id="PQIFiles">
      <Column Id="Id" Type="string" Width="72" PrimaryKey="yes"  Modularize="Column" 
              Category="Identifier"/>
      <Column Id="File" Type="string" Width="255" Modularize="Property"
              Category="Formatted"/>
      <Column Id="FirstLine" Type="string"  Modularize="Property"
              Category="Formatted"/>
      <Row>
        <Data Column="Id">ex15.pqi</Data>
        <Data Column="File">[APPLICATIONFOLDER]examples\ex15.pqi</Data>
        <Data Column="FirstLine">DATABASE [APPLICATIONFOLDER]examples\ex15.dat</Data>
      </Row>
    </CustomTable>
    -->
    <!--
    <CustomTable Id="PQIFile">
      <Column Id="PQIFile" Type="string" Width="72" PrimaryKey="yes"  Modularize="Column"
              Category="Identifier"
              Description="Primary key, non-localized token."/>
      <Column Id="File" Type="string" Width="255" Modularize="Property"
              Category="Formatted"
              Description="The .PQI file in which to write the information"/>
      <Column Id="Value" Type="string"  Modularize="Property"
              Category="Formatted"
              Description="The value to be written."/>
      <Column Id="Component_" Type="string" Width="72" Modularize="Column"
              KeyTable="Component" KeyColumn="1" Category="Identifier"
              Description="Foreign key into the Component table referencing component that controls the installing of the .PQI value."/>
      <Row>
        <Data Column="PQIFile">ex15.pqi</Data>
        <Data Column="File">[APPLICATIONFOLDER]examples\ex15.pqi</Data>
        <Data Column="Value">DATABASE [APPLICATIONFOLDER]examples\ex15.dat</Data>
        <Data Column="Component_">examples</Data>
      </Row>
    </CustomTable>
    -->
    
    <!-- NEW {{ -->
    <CustomActionRef Id="SchedXmlFileSRC"></CustomActionRef>
    <!-- NEW }} -->

    <!-- custom actions -->
    <InstallExecuteSequence>
      <!-- <Custom Action="CustomAction1" After="InstallFiles"/> -->
      <!-- <Custom Action="CustomAction1" After="SchedXmlFile"/> -->
      <!-- Custom Action="CustomAction1" After="SchedXmlFile"/ -->
    </InstallExecuteSequence>
  </Product>
</Wix>
